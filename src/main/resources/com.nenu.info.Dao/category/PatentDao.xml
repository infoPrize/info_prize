<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nenu.info.Dao.category.PatentDao">

    <insert id="add">
        INSERT INTO `t_patent`
        (`patent_name`, `patent_type`, `owner_id_1`, `owner_id_2`, `owner_id_3`, `owner_id_4`, `owner_id_5`, `apply_time`, `teacher_id`, `patent_introduce`)
        VALUES
        (#{patent.patentName}, #{patent.patentType}, #{patent.ownerId1}, #{patent.ownerId2}, #{patent.ownerId3}, #{patent.ownerId4}, #{patent.ownerId5},
         #{patent.applyTime}, #{patent.teacherId}, #{patent.patentIntroduce})
    </insert>

    <select id="listAll" resultType="com.nenu.info.common.dto.category.PatentDto">
        SELECT
            (SELECT tpt.`patent_type` FROM `t_patent_type` tpt WHERE tpt.`id` = tp.`patent_type`) AS patentType,
            tp.`patent_name` AS patentName,
            tp.`apply_time` AS applyTime,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_1`) AS applierName1,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_1` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor1,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_1`) AS applierStuNumber1,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_2`) AS applierName2,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_2` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor2,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_2`) AS applierStuNumber2,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_3`) AS applierName3,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_3` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor3,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_3`) AS applierStuNumber3,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_4`) AS applierName4,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_4` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor4,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_4`) AS applierStuNumber4,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_5`) AS applierName5,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_5` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor5,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_5`) AS applierStuNumber5,
            (SELECT tt.`teacher_name` FROM `t_teacher` tt WHERE tt.`id` = tp.`teacher_id`) AS teacherName
        FROM `t_patent` tp
    </select>

    <select id="countByCondition" resultType="Integer">
        SELECT count(*)
        FROM `t_patent` tp
        <where>
            <include refid="queryCondition" />
        </where>
    </select>

    <select id="listByCondition" resultType="com.nenu.info.common.dto.category.PatentDto">
        SELECT
            tp.`id` AS id,
            (SELECT tpt.`patent_type` FROM `t_patent_type` tpt WHERE tpt.`id` = tp.`patent_type`) AS patentType,
            tp.`patent_name` AS patentName,
            tp.`apply_time` AS applyTime,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_1`) AS applierName1,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_1` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor1,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_1`) AS applierStuNumber1,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_2`) AS applierName2,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_2` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor2,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_2`) AS applierStuNumber2,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_3`) AS applierName3,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_3` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor3,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_3`) AS applierStuNumber3,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_4`) AS applierName4,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_4` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor4,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_4`) AS applierStuNumber4,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_5`) AS applierName5,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_5` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor5,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_5`) AS applierStuNumber5,
            (SELECT tt.`teacher_name` FROM `t_teacher` tt WHERE tt.`id` = tp.`teacher_id`) AS teacherName,
            tp.`patent_introduce` AS introduce
        FROM `t_patent` tp
        <where>
            <include refid="queryCondition" />
        </where>
        ORDER BY `id` DESC
    </select>

    <select id="selectById" resultType="com.nenu.info.common.dto.category.PatentDto">
        SELECT
            tp.`id` AS id,
            (SELECT tpt.`patent_type` FROM `t_patent_type` tpt WHERE tpt.`id` = tp.`patent_type`) AS patentType,
            tp.`patent_name` AS patentName,
            tp.`apply_time` AS applyTime,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_1`) AS applierName1,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_1` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor1,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_1`) AS applierStuNumber1,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_2`) AS applierName2,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_2` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor2,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_2`) AS applierStuNumber2,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_3`) AS applierName3,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_3` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor3,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_3`) AS applierStuNumber3,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_4`) AS applierName4,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_4` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor4,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_4`) AS applierStuNumber4,
            (SELECT ts.`name` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_5`) AS applierName5,
            (SELECT tmc.`major_name` FROM `t_student` ts, `t_major_code` tmc WHERE tp.`owner_id_5` = ts.`id` AND ts.`major_code` = tmc.`major_code`) AS applierMajor5,
            (SELECT ts.`stu_number` FROM `t_student` ts WHERE ts.`id` = tp.`owner_id_5`) AS applierStuNumber5,
            (SELECT tt.`teacher_name` FROM `t_teacher` tt WHERE tt.`id` = tp.`teacher_id`) AS teacherName,
            tp.`patent_introduce` AS introduce
        FROM `t_patent` tp
        WHERE tp.`id` = #{id}
          AND tp.`is_deleted` = 0
    </select>

    <sql id="queryCondition">
        tp.`is_deleted` = 0
        <if test="studentIdList != null and studentIdList.size() > 0">
            AND
            (
            tp.`owner_id_1` IN
            <foreach collection="studentIdList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tp.`owner_id_2` IN
            <foreach collection="studentIdList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tp.`owner_id_3` IN
            <foreach collection="studentIdList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tp.`owner_id_4` IN
            <foreach collection="studentIdList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tp.`owner_id_5` IN
            <foreach collection="studentIdList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </if>
        <if test="teacherId != null">
            AND tp.`teacher_id` = #{teacherId}
        </if>
        <if test="patentType != null and patentType > 0">
            AND tp.`patent_type` = #{patentType}
        </if>
        <if test="patentName != null and patentName != ''">
            AND tp.`patent_name` LIKE CONCAT('%', #{patentName}, '%')
        </if>
        <if test="beginTime != null and endTime != null">
            AND tp.`apply_time` BETWEEN #{beginTime} AND #{endTime}
        </if>
    </sql>

    <update id="falseDeleteById">
        UPDATE `t_patent`
        SET `is_deleted` = 1
        WHERE `id` = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM `t_patent`
        WHERE `id` = #{id}
    </delete>

</mapper>