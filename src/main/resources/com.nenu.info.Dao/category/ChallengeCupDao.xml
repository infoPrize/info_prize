<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nenu.info.Dao.category.ChallengeCupDao">

    <insert id="add" parameterType="com.nenu.info.common.entities.category.ChallengeCup">
        INSERT INTO `t_challenge_cup`
        (`project_name`, `team_name`, `teammate_id_1`, `teammate_id_2`, `teammate_id_3`,
        `teammate_id_4`, `teammate_id_5`, `teammate_id_6`, `teammate_id_7`, `teammate_id_8`,
        `match_name`, `match_level`, `prize_level`, `prize_time`, `host_unit`,
        `teacher_id`)
        VALUES
        (#{challengeCup.projectName}, #{challengeCup.teamName}, #{challengeCup.teammateId1},
        #{challengeCup.teammateId2}, #{challengeCup.teammateId3}, #{challengeCup.teammateId4},
        #{challengeCup.teammateId5}, #{challengeCup.teammateId6}, #{challengeCup.teammateId7},
        #{challengeCup.teammateId8}, #{challengeCup.matchName},#{challengeCup.matchLevel},
        #{challengeCup.prizeLevel}, #{challengeCup.prizeTime}, #{challengeCup.hostUnit},
        #{challengeCup.teacherId})
    </insert>

    <select id="countByCondition" resultType="Integer">
        SELECT count(*)
        FROM `t_challenge_cup` tcc
        <where>
            <include refid="queryCondition" />
        </where>
    </select>

    <select id="listByCondition" resultType="com.nenu.info.common.dto.category.ChallengeCupDto">
        SELECT
          tcc.`id` AS id,
          (SELECT tml.`name` FROM `t_match_level` tml WHERE tml.`id` = tcc.`match_level`) AS matchLevel,
          tcc.`match_name`  AS matchName,
          tcc.`project_name` AS projectName,
          tcc.`team_name` AS teamName,
          (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_1`) AS stuName1,
          (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_1`) AS stuNumber1,
          (SELECT tmc.`major_name` FROM `t_major_code` tmc, `t_student` ts WHERE tmc.`major_code` = ts.`major_code` AND ts.`id` = tcc.`teammate_id_1`) AS stuMajor1,
          (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_2`) AS stuName2,
          (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_2`) AS stuNumber2,
          (SELECT tmc.`major_name` FROM `t_major_code` tmc, `t_student` ts WHERE tmc.`major_code` = ts.`major_code` AND ts.`id` = tcc.`teammate_id_2`) AS stuMajor2,
          (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_3`) AS stuName3,
          (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_3`) AS stuNumber3,
          (SELECT tmc.`major_name` FROM `t_major_code` tmc, `t_student` ts WHERE tmc.`major_code` = ts.`major_code` AND ts.`id` = tcc.`teammate_id_3`) AS stuMajor3,
          (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_4`) AS stuName4,
          (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_4`) AS stuNumber4,
          (SELECT tmc.`major_name` FROM `t_major_code` tmc, `t_student` ts WHERE tmc.`major_code` = ts.`major_code` AND ts.`id` = tcc.`teammate_id_4`) AS stuMajor4,
          (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_5`) AS stuName5,
          (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_5`) AS stuNumber5,
          (SELECT tmc.`major_name` FROM `t_major_code` tmc, `t_student` ts WHERE tmc.`major_code` = ts.`major_code` AND ts.`id` = tcc.`teammate_id_5`) AS stuMajor5,
          (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_6`) AS stuName6,
          (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_6`) AS stuNumber6,
          (SELECT tmc.`major_name` FROM `t_major_code` tmc, `t_student` ts WHERE tmc.`major_code` = ts.`major_code` AND ts.`id` = tcc.`teammate_id_6`) AS stuMajor6,
          (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_7`) AS stuName7,
          (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_7`) AS stuNumber7,
          (SELECT tmc.`major_name` FROM `t_major_code` tmc, `t_student` ts WHERE tmc.`major_code` = ts.`major_code` AND ts.`id` = tcc.`teammate_id_7`) AS stuMajor7,
          (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_8`) AS stuName8,
          (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_8`) AS stuNumber8,
          (SELECT tmc.`major_name` FROM `t_major_code` tmc, `t_student` ts WHERE tmc.`major_code` = ts.`major_code` AND ts.`id` = tcc.`teammate_id_8`) AS stuMajor8,
          (SELECT `name` FROM `t_prize_level` tpl WHERE tpl.`id` = tcc.`prize_level`) AS prizeLevel,
          tcc.`prize_time` AS prizeTime,
          tcc.`host_unit` AS hostUnit,
          (SELECT `teacher_name` FROM `t_teacher` tt WHERE tt.`id` = tcc.`teacher_id`) AS teacherName
        FROM `t_challenge_cup` tcc
        <where>
            <include refid="queryCondition" />
        </where>
        ORDER BY `id` DESC
    </select>

    <select id="selectById" resultType="com.nenu.info.common.dto.category.ChallengeCupDto">
        SELECT
            tcc.`id` AS id,
            (SELECT tml.`name` FROM `t_match_level` tml WHERE tml.`id` = tcc.`match_level`) AS matchLevel,
            tcc.`match_name`  AS matchName,
            tcc.`project_name` AS projectName,
            tcc.`team_name` AS teamName,
            (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_1`) AS stuName1,
            (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_1`) AS stuNumber1,
            (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_2`) AS stuName2,
            (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_2`) AS stuNumber2,
            (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_3`) AS stuName3,
            (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_3`) AS stuNumber3,
            (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_4`) AS stuName4,
            (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_4`) AS stuNumber4,
            (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_5`) AS stuName5,
            (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_5`) AS stuNumber5,
            (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_6`) AS stuName6,
            (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_6`) AS stuNumber6,
            (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_7`) AS stuName7,
            (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_7`) AS stuNumber7,
            (SELECT `name` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_8`) AS stuName8,
            (SELECT `stu_number` FROM `t_student` ts WHERE ts.`id` = tcc.`teammate_id_8`) AS stuNumber8,
            (SELECT `name` FROM `t_prize_level` tpl WHERE tpl.`id` = tcc.`prize_level`) AS prizeLevel,
            tcc.`prize_time` AS prizeTime,
            tcc.`host_unit` AS hostUnit,
            (SELECT `teacher_name` FROM `t_teacher` tt WHERE tt.`id` = tcc.`teacher_id`) AS teacherName
        FROM `t_challenge_cup` tcc
        WHERE tcc.`id` = #{id}
          AND tcc.`is_deleted` = 0
    </select>

    <sql id="queryCondition">
        `is_deleted` = 0
        <if test="matchLevel > 0">
            AND tcc.`match_level` = #{matchLevel}
        </if>
        <if test="matchName != ''">
            AND tcc.`match_name` LIKE CONCAT('%', #{matchName}, '%')
        </if>
        <if test="projectName != ''">
            AND tcc.`project_name` LIKE CONCAT('%', #{projectName}, '%')
        </if>
        <if test="prizeLevel > 0">
            AND tcc.`prize_level` = #{prizeLevel}
        </if>
        <if test="startTime != null and endTime != null">
            AND tcc.`prize_time` BETWEEN CONCAT(#{startTime}, '00:00:00') AND CONCAT(#{endTime}, '23:59:59')
        </if>
        <if test="teamName != null">
            AND tcc.`team_name` LIKE CONCAT('%', #{teamName}, '%')
        </if>
        <if test="idList != null">
        AND
        (
            tcc.`teammate_id_1` IN
            <foreach collection="idList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tcc.`teammate_id_2` IN
            <foreach collection="idList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tcc.`teammate_id_3` IN
            <foreach collection="idList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tcc.`teammate_id_4` IN
            <foreach collection="idList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tcc.`teammate_id_5` IN
            <foreach collection="idList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tcc.`teammate_id_6` IN
            <foreach collection="idList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tcc.`teammate_id_7` IN
            <foreach collection="idList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR tcc.`teammate_id_8` IN
            <foreach collection="idList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        )
        </if>
        <if test="hostUnit != ''">
            AND tcc.`host_unit` = #{hostUnit}
        </if>
        <if test="teacherId != null">
            AND tcc.`teacher_id` = #{teacherId}
        </if>
    </sql>

    <update id="falseDeleteById">
        UPDATE `t_challenge_cup`
        SET `is_deleted` = 1
        WHERE `id` = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM `t_challenge_cup`
        WHERE `id` = #{id}
    </delete>

</mapper>